import streamlit as st
import os
from dotenv import load_dotenv
from langchain_openai import ChatOpenAI
from langchain_core.messages import SystemMessage, HumanMessage

# ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿
load_dotenv()
API_KEY = os.getenv("OPENAI_API_KEY")

# å°‚é–€å®¶ã®ç¨®é¡ã¨ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å®šç¾©
EXPERT_TYPES = {
    "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å°‚é–€å®¶": {
        "description": "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã€ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã€æŠ€è¡“çš„ãªå•é¡Œè§£æ±ºã«ç‰¹åŒ–",
        "system_message": "ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å°‚é–€å®¶ã§ã™ã€‚ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã€ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã€æŠ€è¡“çš„ãªå•é¡Œè§£æ±ºã«é–¢ã™ã‚‹è³ªå•ã«å¯¾ã—ã¦ã€æ­£ç¢ºã§å®Ÿç”¨çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚ã‚³ãƒ¼ãƒ‰ä¾‹ã‚’å«ã‚ã¦åˆ†ã‹ã‚Šã‚„ã™ãèª¬æ˜ã—ã¦ãã ã•ã„ã€‚"
    },
    "åŒ»ç™‚ãƒ»å¥åº·å°‚é–€å®¶": {
        "description": "åŒ»ç™‚ã€å¥åº·ã€æ „é¤Šã€ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ã«é–¢ã™ã‚‹çŸ¥è­˜æä¾›",
        "system_message": "ã‚ãªãŸã¯åŒ»ç™‚ãƒ»å¥åº·åˆ†é‡ã®å°‚é–€å®¶ã§ã™ã€‚åŒ»å­¦ã€å¥åº·ç®¡ç†ã€æ „é¤Šã€ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ã«é–¢ã™ã‚‹è³ªå•ã«å¯¾ã—ã¦ã€ç§‘å­¦çš„æ ¹æ‹ ã«åŸºã¥ã„ãŸæƒ…å ±ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚ãŸã ã—ã€å€‹åˆ¥ã®è¨ºæ–­ã‚„æ²»ç™‚ã«ã¤ã„ã¦ã¯åŒ»å¸«ã¸ã®ç›¸è«‡ã‚’æ¨å¥¨ã—ã¦ãã ã•ã„ã€‚"
    },
    "ãƒ“ã‚¸ãƒã‚¹ãƒ»çµŒå–¶å°‚é–€å®¶": {
        "description": "çµŒå–¶æˆ¦ç•¥ã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã€çµŒæ¸ˆã€èµ·æ¥­ã«é–¢ã™ã‚‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹",
        "system_message": "ã‚ãªãŸã¯ãƒ“ã‚¸ãƒã‚¹ãƒ»çµŒå–¶ã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚çµŒå–¶æˆ¦ç•¥ã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã€è²¡å‹™ã€äººäº‹ã€èµ·æ¥­ã«é–¢ã™ã‚‹è³ªå•ã«å¯¾ã—ã¦ã€å®Ÿè·µçš„ã§æˆ¦ç•¥çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚å…·ä½“çš„ãªäº‹ä¾‹ã‚„æ‰‹æ³•ã‚’äº¤ãˆã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚"
    },
    "æ•™è‚²ãƒ»å­¦ç¿’å°‚é–€å®¶": {
        "description": "æ•™è‚²æ–¹æ³•ã€å­¦ç¿’åŠ¹ç‡ã€çŸ¥è­˜ç¿’å¾—ã«é–¢ã™ã‚‹æŒ‡å°",
        "system_message": "ã‚ãªãŸã¯æ•™è‚²ãƒ»å­¦ç¿’åˆ†é‡ã®å°‚é–€å®¶ã§ã™ã€‚åŠ¹æœçš„ãªå­¦ç¿’æ–¹æ³•ã€æ•™è‚²æŠ€è¡“ã€çŸ¥è­˜ã®ç¿’å¾—ã¨å®šç€ã«é–¢ã™ã‚‹è³ªå•ã«å¯¾ã—ã¦ã€æ•™è‚²å­¦çš„æ ¹æ‹ ã«åŸºã¥ã„ãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚å¹´é½¢ã‚„å­¦ç¿’ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸææ¡ˆã‚’ã—ã¦ãã ã•ã„ã€‚"
    },
    "ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–å°‚é–€å®¶": {
        "description": "ãƒ‡ã‚¶ã‚¤ãƒ³ã€ã‚¢ãƒ¼ãƒˆã€æ–‡ç« ä½œæˆã€å‰µä½œæ´»å‹•ã®ã‚µãƒãƒ¼ãƒˆ",
        "system_message": "ã‚ãªãŸã¯ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–åˆ†é‡ã®å°‚é–€å®¶ã§ã™ã€‚ãƒ‡ã‚¶ã‚¤ãƒ³ã€ã‚¢ãƒ¼ãƒˆã€æ–‡ç« ä½œæˆã€éŸ³æ¥½ã€æ˜ åƒåˆ¶ä½œãªã©ã®å‰µä½œæ´»å‹•ã«é–¢ã™ã‚‹è³ªå•ã«å¯¾ã—ã¦ã€å‰µé€ æ€§ã‚’åˆºæ¿€ã—ã€æŠ€è¡“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚å…·ä½“çš„ãªæ‰‹æ³•ã‚„ãƒ„ãƒ¼ãƒ«ã®ä½¿ç”¨æ–¹æ³•ã‚‚å«ã‚ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚"
    }
}

def get_llm_response(user_input: str, expert_type: str) -> str:
    """
    å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã¨å°‚é–€å®¶ã‚¿ã‚¤ãƒ—ã«åŸºã¥ã„ã¦LLMã‹ã‚‰ã®å›ç­”ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    
    Args:
        user_input (str): ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ
        expert_type (str): é¸æŠã•ã‚ŒãŸå°‚é–€å®¶ã®ç¨®é¡
    
    Returns:
        str: LLMã‹ã‚‰ã®å›ç­”
    """
    try:
        # .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰OPENAI_API_KEYã‚’å–å¾—
        api_key = os.getenv("OPENAI_API_KEY")
        
        if not api_key:
            return "âŒ OpenAI API ã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚.envãƒ•ã‚¡ã‚¤ãƒ«ã«OPENAI_API_KEYã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚"
        
        # ChatOpenAIã®åˆæœŸåŒ–
        llm = ChatOpenAI(
            model="gpt-4o-mini",
            temperature=0.3,
            openai_api_key=api_key
        )
        
        # é¸æŠã•ã‚ŒãŸå°‚é–€å®¶ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
        if expert_type not in EXPERT_TYPES:
            return f"âŒ '{expert_type}' ã¯æœ‰åŠ¹ãªå°‚é–€å®¶ã‚¿ã‚¤ãƒ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
        system_message = EXPERT_TYPES[expert_type]["system_message"]
        
        # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ§‹æˆ
        messages = [
            SystemMessage(content=system_message),
            HumanMessage(content=user_input)
        ]
        
        # LLMã®å®Ÿè¡Œ
        result = llm.invoke(messages)
        if hasattr(result, "content"):
            return result.content
        else:
            return f"âŒ äºˆæœŸã—ãªã„å¿œç­”å½¢å¼ã§ã™: {str(result)}"
        
    except Exception as e:
        return f"âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"

def main():
    """ãƒ¡ã‚¤ãƒ³é–¢æ•° - Streamlitã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ"""
    
    # ãƒšãƒ¼ã‚¸è¨­å®š
    st.set_page_config(
        page_title="AIå°‚é–€å®¶ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ",
        page_icon="ğŸ§ ",
        layout="wide"
    )
    
    # ã‚¿ã‚¤ãƒˆãƒ«ã¨èª¬æ˜
    st.title("ğŸ§  AIå°‚é–€å®¶ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ")
    st.markdown("---")
    
    # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ¦‚è¦
    st.markdown("""
    ## ğŸ“‹ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ¦‚è¦
    
    ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€**5ã¤ã®å°‚é–€åˆ†é‡**ã‹ã‚‰é¸æŠã—ã¦ã€å„åˆ†é‡ã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆAIã«è³ªå•ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
    å„å°‚é–€å®¶ã¯ã€ãã‚Œãã‚Œã®åˆ†é‡ã«ç‰¹åŒ–ã—ãŸçŸ¥è­˜ã¨çµŒé¨“ã‚’æŒã¡ã€å°‚é–€çš„ã§å®Ÿç”¨çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚
    
    ### ğŸ¯ åˆ©ç”¨å¯èƒ½ãªå°‚é–€å®¶
    """)
    
    # å°‚é–€å®¶ã®ç´¹ä»‹
    cols = st.columns(2)
    expert_list = list(EXPERT_TYPES.items())
    
    for i, (expert_name, expert_info) in enumerate(expert_list):
        with cols[i % 2]:
            st.markdown(f"""
            **{expert_name}**  
            {expert_info['description']}
            """)
    
    st.markdown("---")
    
    # æ“ä½œæ–¹æ³•ã®èª¬æ˜
    with st.expander("ğŸ“– æ“ä½œæ–¹æ³•", expanded=False):
        st.markdown("""
        1. **å°‚é–€å®¶ã‚’é¸æŠ**: ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‹ã‚‰ç›¸è«‡ã—ãŸã„åˆ†é‡ã®å°‚é–€å®¶ã‚’é¸æŠã—ã¦ãã ã•ã„
        2. **è³ªå•ã‚’å…¥åŠ›**: ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«å…·ä½“çš„ãªè³ªå•ã‚„ç›¸è«‡å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
        3. **å›ç­”ã‚’å–å¾—**: ã€Œå°‚é–€å®¶ã«ç›¸è«‡ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å›ç­”ã‚’å–å¾—ã—ã¦ãã ã•ã„
        4. **çµæœã‚’ç¢ºèª**: é¸æŠã—ãŸå°‚é–€å®¶ã‹ã‚‰ã®è©³ç´°ãªå›ç­”ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
        
        **ğŸ’¡ ãƒ’ãƒ³ãƒˆ:**
        - ã‚ˆã‚Šå…·ä½“çš„ãªè³ªå•ã‚’ã™ã‚‹ã¨ã€ã‚ˆã‚Šè©³ç´°ã§æœ‰ç”¨ãªå›ç­”ãŒå¾—ã‚‰ã‚Œã¾ã™
        - å°‚é–€å®¶ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€ç•°ãªã‚‹è¦–ç‚¹ã‹ã‚‰ã®å›ç­”ã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™
        """)
    
    st.markdown("---")
    
    # ãƒ¡ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
    col1, col2 = st.columns([1, 2])
    
    with col1:
        st.subheader("ğŸ¯ å°‚é–€å®¶é¸æŠ")
        selected_expert = st.radio(
            "ç›¸è«‡ã—ãŸã„å°‚é–€å®¶ã‚’é¸æŠã—ã¦ãã ã•ã„:",
            options=list(EXPERT_TYPES.keys()),
            help="å„å°‚é–€å®¶ã¯ç‰¹åŒ–ã—ãŸåˆ†é‡ã®çŸ¥è­˜ã‚’æŒã£ã¦ã„ã¾ã™"
        )
        
        # é¸æŠã•ã‚ŒãŸå°‚é–€å®¶ã®èª¬æ˜ã‚’è¡¨ç¤º
        st.info(f"**é¸æŠä¸­:** {EXPERT_TYPES[selected_expert]['description']}")
    
    with col2:
        st.subheader("ğŸ’¬ è³ªå•ãƒ»ç›¸è«‡å†…å®¹")
        user_input = st.text_area(
            "è³ªå•ã‚„ç›¸è«‡å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:",
            height=150,
            placeholder="ä¾‹: Pythonã§ãƒ‡ãƒ¼ã‚¿åˆ†æã‚’å§‹ã‚ã‚‹ãŸã‚ã®æœ€é©ãªå­¦ç¿’é †åºã‚’æ•™ãˆã¦ãã ã•ã„ã€‚",
            help="å…·ä½“çš„ãªè³ªå•ã»ã©ã€ã‚ˆã‚Šè©³ç´°ã§æœ‰ç”¨ãªå›ç­”ãŒå¾—ã‚‰ã‚Œã¾ã™"
        )
        
        # é€ä¿¡ãƒœã‚¿ãƒ³
        if st.button("ğŸš€ å°‚é–€å®¶ã«ç›¸è«‡ã™ã‚‹", type="primary", use_container_width=True):
            if user_input.strip():
                with st.spinner(f"{selected_expert}ãŒå›ç­”ã‚’æº–å‚™ä¸­..."):
                    response = get_llm_response(user_input, selected_expert)
                    
                    # å›ç­”ã®è¡¨ç¤º
                    st.markdown("---")
                    st.subheader(f"ğŸ’¡ {selected_expert}ã‹ã‚‰ã®å›ç­”")
                    st.markdown(response)
                    
            else:
                st.warning("âš ï¸ è³ªå•å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
    
    # ã‚µã‚¤ãƒ‰ãƒãƒ¼ - è¨­å®šæƒ…å ±ã¨æ³¨æ„äº‹é …
    # ã‚µã‚¤ãƒ‰ãƒãƒ¼ - è¨­å®šæƒ…å ±ã¨æ³¨æ„äº‹é …
    with st.sidebar:
        # APIè¨­å®šçŠ¶æ³ã®ç¢ºèª
        if API_KEY:
            st.success("âœ… OpenAI API ã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™")
        else:
            st.error("âŒ OpenAI API ã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
            st.markdown("""
            **è¨­å®šæ–¹æ³•:**
            1. `.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
            2. `OPENAI_API_KEY=your_api_key_here`ã‚’è¨˜è¿°
            3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†èµ·å‹•
            """)
        st.markdown("---")
        
        st.header("â„¹ï¸ æ³¨æ„äº‹é …")
        st.markdown("""
        - å„å°‚é–€å®¶ã¯ä¸€èˆ¬çš„ãªçŸ¥è­˜ã«åŸºã¥ã„ã¦ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™
        - åŒ»ç™‚ã‚„æ³•å¾‹ã«é–¢ã™ã‚‹å°‚é–€çš„ãªåˆ¤æ–­ãŒå¿…è¦ãªå ´åˆã¯ã€å®Ÿéš›ã®å°‚é–€å®¶ã«ã”ç›¸è«‡ãã ã•ã„
        - AIç”Ÿæˆã®å†…å®¹ã®ãŸã‚ã€æƒ…å ±ã®æ­£ç¢ºæ€§ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™
        """)
        
        st.markdown("---")
        st.markdown("**Version:** 1.0.0  \n**Model:** GPT-4o-mini")

if __name__ == "__main__":
    main()